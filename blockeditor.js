'use strict';
/*!
 * Block Based Editor for OpenCart
 * https://chiaseek.com/
 *
 * Copyright OpenJS Foundation and other contributors
 * Released under the MIT license
 *
 * Date: 2024-12-07T16:37
 */ 
document.addEventListener("DOMContentLoaded",(e=>{const t=document.querySelectorAll(".editor");for(let e=0;e<t.length;e++){const n=t[e].id;document.querySelector("#"+n+" .generate").addEventListener("click",generate),document.querySelector("#"+n+" .addImg").addEventListener("click",(()=>addImageBlock(n,!1))),document.querySelector("#"+n+" .addVideo").addEventListener("click",(()=>addVideoBlock(n,!1))),document.querySelector("#"+n+" .addBlock").addEventListener("click",(()=>addBlock(n,!1))),document.querySelector("#"+n+" .addTable").addEventListener("click",(()=>addTable(n,!1)));let o=document.querySelector("#"+n);o.addEventListener("click",(e=>{e.preventDefault();const t=e.target.getAttribute("data-block"),l=document.getElementById("TB"+t);if(e.target.classList.contains("removeBlock")){if(""!==document.getElementById(t).innerText.trim()){return void(confirm("Are you sure you want to delete this block?")&&l.remove())}l.remove()}const a=document.querySelector("#"+n+" .blocks");if(e.target.classList.contains("moveUp")){let t=e.target.closest(".tempblock");t&&t.previousElementSibling&&a.insertBefore(t,t.previousElementSibling)}if(e.target.classList.contains("moveDown")){let t=e.target.closest(".tempblock");t&&t.nextElementSibling&&a.insertBefore(t.nextElementSibling,t)}if(e.target.classList.contains("menuOnOff")){const e=document.querySelectorAll(".toolbar");for(let t=0;t<e.length;t++){e[t].classList.remove("active")}let n=document.querySelector("#MN"+t),o=document.querySelector("#TM"+t);n.classList.contains("active")?(n.classList.remove("active"),o.classList.remove("active")):(n.classList.add("active"),o.classList.add("active"))}o.addEventListener("click",(e=>closeMenu(e)));let c={h1:()=>convertToTag(n,t,"h1"),h2:()=>convertToTag(n,t,"h2"),h3:()=>convertToTag(n,t,"h3"),h4:()=>convertToTag(n,t,"h4"),h5:()=>convertToTag(n,t,"h5"),h6:()=>convertToTag(n,t,"h6"),div:()=>convertToTag(n,t,"div"),blockquote:()=>convertToTag(n,t,"blockquote"),p:()=>convertToTag(n,t,"p"),ol:()=>convertToTag(n,t,"ol"),ul:()=>convertToTag(n,t,"ul"),addBtnBlock:()=>addBlock(n,t),addImageBlock:()=>addImageBlock(n,t),imgAlt:()=>imageOption(t,"alt"),imgUpload:()=>imageUpload(t),imgURL:()=>imageOption(t,"link"),imgWidth:()=>imageOption(t,"width"),imgHeight:()=>imageOption(t,"height"),imgRemove:()=>imageOption(t,"removeCaption"),imgAdd:()=>imageOption(t,"addCaption"),embedURL:()=>embedOption(t,"link"),embedWidth:()=>embedOption(t,"width"),embedHeight:()=>embedOption(t,"height"),removeCaption:()=>tableOption(t,"removeCaption"),addCaption:()=>tableOption(t,"addCaption"),addRow:()=>tableOption(t,"addRow"),removeRow:()=>tableOption(t,"removeRow"),addCol:()=>tableOption(t,"addColumn"),removeCol:()=>tableOption(t,"removeColumn")};for(let[t,n]of Object.entries(c))if(e.target.classList.contains(t)){n();break}if(e.target.classList.contains("tempblock")||e.target.classList.contains("editor")){const e=document.querySelectorAll(".toolbar");for(let t=0;t<e.length;t++)e[t].classList.remove("active")}})),o.addEventListener("focus",(e=>{if(e.target.matches('[contenteditable="true"]')){let t=e.target.id||e.target.dataset.block,n=document.getElementById("TBAR"+t);const o=document.querySelectorAll(".toolbar");for(let e=0;e<o.length;e++)o[e].classList.remove("active");n.classList.add("active")}}),!0);const l=()=>{document.fullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen(),c.textContent="Fullscreen"):(o.requestFullscreen?o.requestFullscreen():o.mozRequestFullScreen?o.mozRequestFullScreen():o.webkitRequestFullscreen?o.webkitRequestFullscreen():o.msRequestFullscreen&&o.msRequestFullscreen(),c.textContent="Exit Fullscreen")},a=()=>{document.fullscreenElement?c.textContent="Exit Fullscreen":c.textContent="Fullscreen"},c=document.querySelector("#"+n+" .fullscreen");c.addEventListener("click",l),document.addEventListener("fullscreenchange",a),document.addEventListener("mozfullscreenchange",a),document.addEventListener("webkitfullscreenchange",a),document.addEventListener("msfullscreenchange",a);const r=e=>{let t=document.createElement("div");t.id="saveItem"+e,t.classList.add("saved-item");for(let n=0;n<localStorage.length;n++)if(localStorage.key(n)===e){let n=localStorage.getItem(e+"-date");t.textContent=n?"Found Saved: Draft "+n:"Found Saved: Draft ";let o=document.createElement("button");o.dataset.editor=e,o.type="button",o.textContent="Restored";let l=document.createElement("button");l.type="button",l.dataset.editor=e,l.textContent="Clear",l.addEventListener("click",(()=>{let e=l.dataset.editor;localStore.clear(e),localStore.clear(e+"-date"),document.getElementById("saveItem"+e).remove()})),o.addEventListener("click",(()=>{let e=o.dataset.editor,t=localStorage.getItem(e);if(t){const n=document.querySelector("#"+e+" .results");document.getElementById(n.id).innerHTML=restoreAngleBrackets(t),processContent(e,n.id),document.getElementById("saveItemeditor").textContent="Restored Done."}})),t.appendChild(o),t.appendChild(l),document.querySelector("#"+e+" .blocks").insertAdjacentElement("beforebegin",t)}};r(n)}document.body.appendChild((()=>{let e=document.createElement("dialog");e.id="dialog",e.className="linkdialog";const t=document.createElement("div");t.className="dialogbox";const n=document.createElement("div");n.textContent="Edit Link",t.appendChild(n);const o=document.createElement("div");o.className="inputbox";const l=document.createElement("label");l.setAttribute("for","url"),l.textContent="URL:";const a=document.createElement("input");a.type="text",a.id="url",o.appendChild(l),o.appendChild(a),t.appendChild(o);const c=document.createElement("div");c.className="inputbox";const r=document.createElement("label");r.setAttribute("for","rel"),r.textContent="URL rel:";const d=document.createElement("input");d.type="text",d.id="rel",c.appendChild(r),c.appendChild(d),t.appendChild(c);const i=document.createElement("div");i.className="inputbox";const s=document.createElement("label");s.setAttribute("for","target"),s.textContent="URL target:";const m=document.createElement("select");m.id="target",m.className="linkTarget";["_self","_blank","_parent","_top"].forEach((e=>{let t=document.createElement("option");t.value=e,t.textContent=e,m.appendChild(t)})),i.appendChild(s),i.appendChild(m),t.appendChild(i);const u=document.createElement("div");u.className="inputcontrol";const p=document.createElement("button");p.id="updatelink",p.className="updatelink",p.textContent="Save";const b=document.createElement("button");b.id="cancel",b.className="cancel",b.textContent="Cancel";const g=document.createElement("button");return g.id="removelink",g.className="removelink",g.textContent="Remove Link",u.appendChild(p),u.appendChild(b),u.appendChild(g),t.appendChild(u),e.appendChild(t),e})())}));const keyboardSupport=(e,t)=>{e.addEventListener("keydown",(n=>{if("UL"!==e.tagName&&"OL"!==e.tagName&&("Enter"===n.key&&(n.preventDefault(),addBlock(t,!1),e.blur()),"Delete"===n.key||"Backspace"===n.key)){let t=e.querySelector("br");e.innerText.trim();document.execCommand("insertHTML",!1,""),t&&(n.preventDefault(),t.remove())}})),e.addEventListener("paste",(e=>{e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text/plain");document.execCommand("insertHTML",!1,""),document.execCommand("insertText",!1,t.replace(/<br[^>]*>/g,"*").replace(/[\r\n]+/g,"**"))}))},closeMenu=e=>{e.preventDefault();const t=document.querySelectorAll(".menu"),n=document.querySelectorAll(".topMenu"),o=document.querySelectorAll(".menuOnOff");for(let l=0;l<t.length;l++){const a=t[l];a.classList.contains("active")&&(a.contains(e.target)||o[l].contains(e.target)||(a.classList.remove("active"),n[l].classList.remove("active")))}},addTable=(e,t)=>{const n=prompt("Enter Number Rows:",5),o=prompt("Enter Number Columns:",4),l=document.querySelector("#"+e+" .blocks"),a=document.createElement("div");a.setAttribute("tabindex","0"),a.id=Date.now()%1e4,a.className="block",n>0&&o>0?createTable(a,n,o):createTable(a,5,4);const c=createMenuList(a.id,a,"table");if(t>0){const e=document.getElementById("TB"+t);e&&e.insertAdjacentElement("beforebegin",c)}else l.appendChild(c);a.querySelector("caption").focus(),inlineTool(e,a.id)},createTable=(e,t,n)=>{const o=e;if(!o)return void console.error("Container not found");const l=document.createElement("table");l.id="table"+e.id;const a=document.createElement("caption");a.setAttribute("data-placeholder","Table Caption"),a.setAttribute("contenteditable","true"),a.dataset.block=e.id,l.appendChild(a);for(let o=0;o<t;o++){const t=document.createElement("tr");for(let l=0;l<n;l++){const n=document.createElement("td");n.setAttribute("contenteditable","true"),n.dataset.block=e.id,n.textContent=`Row ${o+1}, Col ${l+1}`,t.appendChild(n)}l.appendChild(t)}o.appendChild(l)},addImageBlock=(e,t)=>{const n=document.querySelector("#"+e+" .blocks"),o=document.createElement("figure");o.setAttribute("tabindex","0"),o.id=Date.now()%1e4,o.className="block";const l=document.createElement("picture");l.innerHTML='<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTuv7GqevqRqUgCNaskcs87rvMxqN-jENlxNQ&s" alt="" />',o.appendChild(l);const a=document.createElement("figcaption");a.setAttribute("contenteditable","true"),a.dataset.block=o.id,a.setAttribute("data-placeholder","Image Description"),o.appendChild(a);const c=createMenuList(o.id,o,"image");if(t>0){const e=document.getElementById("TB"+t);e&&e.insertAdjacentElement("beforebegin",c)}else n.appendChild(c);a.focus(),inlineTool(e,o.id)},addVideoBlock=(e,t)=>{const n=document.querySelector("#"+e+" .blocks"),o=document.createElement("embed");o.setAttribute("tabindex","0"),o.id=Date.now()%1e4,o.className="block",o.width="315",o.height="560",o.src="https://www.youtube.com/embed/5ncnsuNm-6A?si=0FUJ5K2LWydm_7oa";const l=createMenuList(o.id,o,"embed");if(t>0){const e=document.getElementById("TB"+t);e&&e.insertAdjacentElement("beforebegin",l)}else n.appendChild(l)},addBlock=(e,t)=>{const n=document.querySelector("#"+e+" .blocks"),o=document.createElement("p");o.setAttribute("contenteditable","true"),o.setAttribute("tabindex","0"),o.setAttribute("data-placeholder","Type something..."),o.id=Date.now()%1e4,o.className="block";const l=createMenuList(o.id,o,"general");if(t>0){const e=document.getElementById("TB"+t);e&&e.insertAdjacentElement("beforebegin",l)}else n.appendChild(l);o.focus(),inlineTool(e,o.id)},createMenuList=(e,t,n)=>{let o=document.createElement("div");o.dataset.block=t.id,o.id="TB"+e,o.className="tempblock";let l=document.createElement("button");l.className="menuOnOff",l.dataset.block=t.id,l.innerText="table"===n?"TABLE":t.tagName,o.appendChild(l);let a=document.createElement("div");a.className="topMenu",a.id="TM"+t.id;let c=document.createElement("button");c.className="addBtnBlock",c.dataset.block=t.id,c.textContent="+Block";let r=document.createElement("button");r.className="addImageBlock",r.dataset.block=t.id,r.textContent="+Image";let d=document.createElement("button");d.className="moveUp",d.dataset.block=t.id,d.textContent="Up";let i=document.createElement("button");i.className="moveDown",i.dataset.block=t.id,i.textContent="Down",a.appendChild(c),a.appendChild(r),a.appendChild(d),a.appendChild(i),o.appendChild(a);let s,m=document.createElement("ul");m.className="menu",m.id="MN"+t.id,m.dataset.block=t.id,s="image"===n?[{className:"removeBlock",text:"Remove Image"},{className:"imgUpload",text:"Upload Image"},{className:"imgURL",text:"Image URL"},{className:"imgRemove",text:"Remove Caption"},{className:"imgAdd",text:"Add Caption"},{className:"imgWidth",text:"Image Width"},{className:"imgHeight",text:"Image Height"},{className:"imgAlt",text:"Alt"}]:"embed"===n?[{className:"removeBlock",text:"Remove Embed"},{className:"embedURL",text:"Embed URL"},{className:"embedWidth",text:"Width"},{className:"embedHeight",text:"Height"}]:"table"===n?[{className:"removeBlock",text:"Remove Table"},{className:"removeCaption",text:"Remove Caption"},{className:"addCaption",text:"Add Caption"},{className:"addRow",text:"Add Row"},{className:"removeRow",text:"Remove Row"},{className:"addCol",text:"Add Column"},{className:"removeCol",text:"Remove Column"}]:[{className:"removeBlock",text:"Remove"},{className:"p",text:"Paragraph"},{className:"div",text:"DIV"},{className:"h1",text:"H1 Heading"},{className:"h2",text:"H2 Heading"},{className:"h3",text:"H3 Heading"},{className:"h4",text:"H4 Heading"},{className:"h5",text:"H5 Heading"},{className:"h6",text:"H6 Heading"},{className:"ul",text:"UL List"},{className:"ol",text:"OL List"},{className:"blockquote",text:"Blockquote"}];for(let e=0;e<s.length;e++){const{className:n,text:o}=s[e],l=document.createElement("button");l.type="button",l.dataset.block=t.id,l.className=n,l.textContent=o,t.tagName.toLowerCase()===n&&(l.disabled=!0),m.appendChild(l)}return o.appendChild(t),o.appendChild(m),o.appendChild(inlineToolbar(t.id)),o},inlineToolbar=e=>{const t=document.createElement("div");t.className="toolbar",t.id="TBAR"+e,t.dataset.block=e;const n=[{className:"removeFormattingButton",text:"X",title:"Remove formmatting or close"},{className:"boldButton",text:"B",title:"Bold Selected Text"},{className:"italicButton",text:"I",title:"Italic text"},{className:"underlineButton",text:"U",title:"Underline Selected Text"},{className:"quoteButton",text:'"',title:"Insert quotation marks"},{className:"markButton",text:"Mark",title:"Marked text"},{className:"delButton",text:"del",title:"Deleted text"},{className:"codeButton",text:"Code",title:"Change Selected Text to Code"},{className:"insertLink",text:"+Link",title:"Insert Link"}];for(let o=0;o<n.length;o++){const l=n[o],a=document.createElement("button");a.type="button",a.className=l.className,a.ariaLabel=l.title,a.dataset.block=e,a.innerHTML=l.text,t.appendChild(a)}return t},removeEmptyAttributes=()=>{document.querySelectorAll("*").forEach((e=>{Array.from(e.attributes).forEach((t=>{""===t.value&&e.removeAttribute(t.name)}))}))};function generate(){const e=this.getAttribute("data-box"),t=this.getAttribute("data-editor");document.getElementById(e).value="";const n=document.querySelectorAll("#"+t+" .blocks .block");removeEmptyAttributes();let o=[];for(let e=0;e<n.length;e++){const t=n[e].cloneNode(!0);t.removeAttribute("contenteditable"),t.removeAttribute("tabindex"),t.removeAttribute("id"),t.removeAttribute("class"),t.removeAttribute("data-placeholder"),t.removeAttribute("data-block");const l=t.querySelectorAll('[contenteditable="true"]');if(l.length>0)for(let e=0;e<l.length;e++)l[e].removeAttribute("contenteditable");t.querySelectorAll("*").forEach((e=>{Array.from(e.attributes).forEach((t=>{t.name.startsWith("data-")&&e.removeAttribute(t.name)}))})),cleanUpNestedTags(t),t.innerHTML=t.innerHTML.replace(/<br[^>]*>/g,""),t.innerHTML=t.innerHTML.replace(/<li[^>]*>\s*<\/li>/g,""),t.innerHTML=t.innerHTML.replace(/id="table[^"]*"/g,""),("embed"===t.tagName.toLowerCase()||"figure"===t.tagName.toLowerCase()||""!==t.textContent.trim()&&""!==t.innerHTML.trim())&&o.push(t.outerHTML)}let l=o.join("\n");l=l.replace(/<br[^>]*>/g,"").replace(/\n/g,""),l=l.replace(/[\r\n]+/g,"");let a=sanitizeHtml(l);document.getElementById(e).value=sanitizeHtml(a),l.length>0&&localStore.save(t,replaceAngleBrackets(sanitizeHtml(a)))}const cleanUpNestedTags=e=>{const t=["strong","em","b","i","br","span"];for(let n=0;n<t.length;n++){const o=t[n],l=e.getElementsByTagName(o);for(let e=l.length-1;e>=0;e--){const t=l[e];if(t.parentNode&&t.parentNode.tagName.toLowerCase()===o){for(;t.firstChild;)t.parentNode.insertBefore(t.firstChild,t);t.parentNode.removeChild(t)}}}},convertToTag=(e,t,n)=>{const o=document.getElementById(t),l=o.tagName,a=o.innerText,c=document.createElement(n);if(c.setAttribute("contenteditable","true"),c.setAttribute("tabindex","0"),c.id=t,c.setAttribute("data-placeholder","Type something..."),c.className="block","OL"===l&&"ul"===n||"UL"===l&&"ol"===n){const e=o.querySelectorAll("li");for(let t=0;t<e.length;t++){const n=e[t],o=document.createElement("li");o.innerText=n.innerText,c.appendChild(o)}}else if("ol"===n||"ul"===n){const e=document.createElement("li");e.innerText=a,c.appendChild(e)}else c.innerText=a.replace(/<br[^>]*>/g,"").replace(/[\r\n]+/g,"");o.replaceWith(c),inlineTool(e,t),c.focus(),document.querySelector("#MN"+t+" ."+n).disabled=!0,document.querySelector("#MN"+t+" ."+l.toLowerCase()).disabled=!1,document.querySelector("#TB"+t+" .menuOnOff").innerText=n.toUpperCase()},inlineTool=(e,t)=>{document.querySelector("#"+e).querySelector("#TB"+t);const n=document.getElementById(t),o=document.getElementById("TBAR"+t)||document.querySelector("#TB"+t+" .toolbar"),l=o.querySelector(".boldButton"),a=o.querySelector(".quoteButton"),c=o.querySelector(".markButton"),r=o.querySelector(".delButton"),d=o.querySelector(".italicButton"),i=o.querySelector(".underlineButton"),s=o.querySelector(".codeButton"),m=o.querySelector(".removeFormattingButton"),u=o.querySelector(".insertLink");keyboardSupport(n,e),l.addEventListener("click",(()=>{p("strong")})),d.addEventListener("click",(()=>{p("em")})),i.addEventListener("click",(()=>{p("u")})),a.addEventListener("click",(()=>{p("q")})),c.addEventListener("click",(()=>{p("mark")})),r.addEventListener("click",(()=>{p("del")})),s.addEventListener("click",(()=>{p("code")})),n.addEventListener("keydown",(e=>{if(e.ctrlKey)switch(e.key){case"b":e.preventDefault(),p("strong");break;case"i":e.preventDefault(),p("em");break;case"u":e.preventDefault(),p("u");break;case"q":e.preventDefault(),p("q");break;case"m":e.preventDefault(),p("mark");break;case"d":e.preventDefault(),p("del");break;case"o":e.preventDefault(),p("code");break;case"x":e.preventDefault(),g();break;case"l":e.preventDefault(),b()}}));const p=e=>{const t=window.getSelection();if(t.rangeCount>0){const n=t.getRangeAt(0),l=n.extractContents(),a=l.textContent.trim(),c=document.createTextNode(a);if("function"==typeof document.execCommand){const t=document.createElement(e);t.appendChild(c),n.insertNode(t),l.textContent.endsWith(" ")?document.execCommand("insertHTML",!1,t.outerHTML+" "):document.execCommand("insertHTML",!1,t.outerHTML)}else{const t=l.parentNode;if(t&&t.nodeName.toLowerCase()===e)t.textContent=a;else{const t=document.createElement(e);let o;l.textContent.endsWith(" ")&&(o=document.createTextNode(" "),n.insertNode(o)),t.appendChild(c),n.insertNode(t)}}o.classList.remove("active")}else alert("No text selected. Please select some text to link.")};function b(){const e=window.getSelection(),n=prompt("Enter the link URL:","https://");if(n){if(e.rangeCount>0){const o=e.getRangeAt(0),l=e.toString().trim(),a=document.createElement("a");a.href=n,a.target="_self",a.rel="noopener",a.textContent=l,a.dataset.block=t;const c=o.cloneContents().textContent;if(o.deleteContents(),c.endsWith(" ")){const e=document.createTextNode(" ");o.insertNode(e)}o.insertNode(a),a.addEventListener("click",k)}return!1}o.classList.remove("active")}function g(){const e=window.getSelection();if(e.rangeCount>0){const t=e.getRangeAt(0),n=t.extractContents(),l=document.createElement("div");l.appendChild(n);const a=l.querySelectorAll("a");for(let e=0;e<a.length;e++){const t=document.createTextNode(a[e].textContent);a[e].parentNode.replaceChild(t,a[e])}const c=document.createTextNode(l.textContent);t.deleteContents(),t.insertNode(c),o.classList.remove("active")}}m.addEventListener("click",(()=>{g()})),u.addEventListener("click",(e=>{b()}));const h=document.querySelectorAll('[contenteditable="true"] a'),v=document.querySelector(".linkdialog");let f=null;function k(e){e.preventDefault(),f=this,document.getElementById("url").value=f.getAttribute("href"),document.getElementById("rel").value=f.rel,document.getElementById("target").value=f.target,v.showModal()}for(let e=0;e<h.length;e++)h[e].addEventListener("click",k);document.getElementById("updatelink").addEventListener("click",(function(){f&&(f.href=document.getElementById("url").value,f.rel=document.getElementById("rel").value,f.target=document.getElementById("target").value),v.close()})),document.getElementById("removelink").addEventListener("click",(function(){if(f){event.preventDefault();const e=f.textContent;f.replaceWith(e)}v.close()})),document.getElementById("cancel").addEventListener("click",(()=>{v.close()}))},tableOption=(e,t)=>{const n=document.getElementById("table"+e),o=n.rows.length;switch(t){case"addRow":const l=n.insertRow(-1),a=n.rows[0].cells.length;for(let t=0;t<a;t++){const n=l.insertCell(t);n.setAttribute("contenteditable","true"),n.dataset.block=e,n.innerHTML="New Row, Cell "+(t+1)}break;case"removeRow":o>1?n.deleteRow(o-1):alert("Cannot remove the header row.");break;case"addColumn":for(let t=0;t<o;t++){const o=n.rows[t].insertCell(-1);o.setAttribute("contenteditable","true"),o.dataset.block=e,o.innerHTML="New Cell "+(t+1)}break;case"removeColumn":if(n.rows[0].cells.length>1)for(let e=0;e<o;e++)n.rows[e].deleteCell(-1);else alert("Cannot remove the last column.");break;case"removeCaption":const c=n.querySelector("caption");c&&n.removeChild(c);break;case"addCaption":const r=document.createElement("caption");r.setAttribute("contenteditable","true"),r.setAttribute("data-placeholder","Table Caption"),r.dataset.block=e,n.appendChild(r);break;default:console.warn("Unknown option:",t)}},imageOption=(e,t)=>{const n=document.getElementById(e),o=n?.querySelector("img");if(!o)return void console.error(`Image element not found in block with ID: ${e}`);let l;switch(t){case"alt":l=prompt("Image Alt:",o.alt),l&&(o.alt=l);break;case"link":l=prompt("Image Link:",o.src),l&&(o.src=l);break;case"width":l=prompt("Image Width:",o.width),l&&(o.width=l);break;case"height":l=prompt("Image Height:",o.height),l&&(o.height=l);break;case"removeCaption":const a=n.querySelector("figcaption");a?n.removeChild(a):console.warn("No caption found to remove.");break;case"addCaption":const c=document.createElement("figcaption");c.setAttribute("contenteditable","true"),c.setAttribute("data-placeholder","Image Description"),c.dataset.block=e,n.appendChild(c);break;default:console.error("Invalid option: "+t)}},embedOption=(e,t)=>{const n=document.getElementById(e);if(!n)return void console.error(`Element with ID ${e} not found.`);let o;switch(t){case"link":o=prompt("Embed Link:",n.src),o&&(n.src=o);break;case"width":o=prompt("Embed Width:",n.width),o&&(n.width=o);break;case"height":o=prompt("Embed Height:",n.height),o&&(n.height=o);break;default:console.error("Invalid option: "+t)}};function imageUpload(e){const t=document.getElementById("form-upload");t&&t.remove();const n=document.createElement("form");n.enctype="multipart/form-data",n.id="form-upload",n.style.display="none";const o=document.createElement("input");o.type="file",o.name="file[]",o.multiple=!0,n.appendChild(o),document.body.prepend(n),o.click(),"undefined"!=typeof timer&&clearInterval(timer),timer=setInterval((function(){if(""!==o.value){clearInterval(timer);const t=new FormData(n);fetch("index.php?route=common/filemanager/upload&token=<?php echo $token; ?>&directory="+"",{method:"POST",body:t}).then((e=>e.json())).then((t=>{if(console.log("Upload: "+t.file.url),t.error&&alert(t.error),t.success){document.getElementById(e).querySelector("img").src=t.file.url}})).catch((e=>{alert(e)})).finally((()=>{}))}}),500)}function processContent(e,t){const n=document.getElementById(t).value.replace(/[\r\n]+/g," ").replace(/\s{2,}/g," ").replace(/>\s+</g,"><").replace(/<span[^>]*>(.*?)<\/span>/gi,"$1"),o=(new DOMParser).parseFromString(n,"text/html");o.querySelectorAll("span").forEach((e=>e.remove()));o.querySelectorAll("br").forEach((e=>e.remove()));const l=document.querySelector("#"+e+" .blocks");l.innerHTML="";let a=Date.now()%1e4;const c=o.body.childNodes;for(let t=0;t<c.length;t++){const n=c[t];if(n.nodeType===Node.ELEMENT_NODE){const t=n.tagName.toLowerCase();let o;if("img"===t){o=document.createElement("figure"),o.setAttribute("tabindex","0"),o.id=a,o.className="block";const e=document.createElement("picture"),t=document.createElement("img");t.src=n.src;const l=document.createElement("figcaption");l.setAttribute("data-placeholder","Image Description"),l.setAttribute("contenteditable","true"),l.dataset.block=a,e.appendChild(t),o.appendChild(e),o.appendChild(l)}else{const e=(new DOMParser).parseFromString(n.innerHTML,"text/html"),l=e.querySelector("table"),c=e.querySelectorAll("a"),r=e.querySelectorAll("caption"),d=e.querySelectorAll("td"),i=e.querySelectorAll("figcaption");if(d.length>0)for(let e=0;e<d.length;e++)d[e].setAttribute("contenteditable","true"),d[e].dataset.block=a;if(r.length>0)for(let e=0;e<r.length;e++)r[e].setAttribute("contenteditable","true"),r[e].setAttribute("data-placeholder","Table Caption"),r[e].dataset.block=a;if(c.length>0)for(let e=0;e<c.length;e++)c[e].dataset.block=a;if(l&&(l.id="table"+a),i.length>0)for(let e=0;e<i.length;e++)i[e].setAttribute("contenteditable","true"),i[e].setAttribute("data-placeholder","Image Description"),i[e].dataset.block=a;n.innerHTML=e.body.innerHTML,o=document.createElement(t),o.innerHTML=n.innerHTML,o.setAttribute("contenteditable","true"),o.setAttribute("tabindex","0"),o.id=a,o.className="block","embed"===t&&(o.src=n.src,o.width=n.width,o.height=n.height,o.removeAttribute("contenteditable")),(n.innerHTML.includes("<table")||/<table\b[^>]*>/i.test(n.innerHTML))&&o.removeAttribute("contenteditable"),"figure"===t&&o.removeAttribute("contenteditable")}if("figure"===t||"img"===t){const e=createMenuList(a,o,"image");l.appendChild(e)}else if("embed"===t){const e=createMenuList(a,o,"embed");l.appendChild(e)}else if(n.innerHTML.includes("<table")||/<table\b[^>]*>/i.test(n.innerHTML)){const e=createMenuList(a,o,"table");l.appendChild(e)}else{const e=createMenuList(a,o,"general");l.appendChild(e)}inlineTool(e,a),a++}}}function sanitizeHtml(e){const t=document.createElement("div");t.innerHTML=e;const n=["b","i","em","strong","q","mark","del","a","p","u","ul","ol","li","h1","h2","h3","h4","h5","h6","img","table","tr","td","embed"];return function e(t){if(t.nodeType===Node.ELEMENT_NODE){if(!n.includes(t.tagName.toLowerCase()))return void t.remove();const o=[];for(let e of Array.from(t.attributes))"href"!==e.name&&"target"!==e.name&&o.push(e.name);for(let e of o)t.removeAttribute(e);for(let n of Array.from(t.childNodes))e(n)}}(t),t.innerHTML}document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelectorAll(".results");for(let t=0;t<e.length;t++){const n=e[t],o=n.getAttribute("data-editor");""!==n.value.trim()?processContent(o,n.id):addBlock(o,!1)}}));const replaceAngleBrackets=e=>e.replace(/</g,"/**").replace(/>/g,"**/"),restoreAngleBrackets=e=>e.replace(/\/\*\*/g,"<").replace(/\*\*\//g,">"),localStore={save:(e,t)=>{const n=new Date;localStorage.setItem(e,t),localStorage.setItem(e+"-date",n.toISOString())},load:(e,t)=>{const n=localStorage.getItem(e);n&&(document.getElementById("results"+e).innerHTML=n)},clear:e=>{localStorage.removeItem(e)}};
